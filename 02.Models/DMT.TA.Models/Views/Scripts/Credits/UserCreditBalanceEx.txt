SELECT UserCreditBalance.UserCreditId
	 , UserCreditBalance.UserCreditDate
	 , TS.TSBShiftId
	 , TS.TSBShiftBegin
	 , TS.TSBShiftEnd
	 , UserCreditBalance.BagNo
	 , UserCreditBalance.BeltNo
	 , UserCreditBalance.TSBId
	 , TSB.TSBNameEN
	 , TSB.TSBNameTH
	 , UserCreditBalance.PlazaGroupId
	 , PlazaGroup.PlazaGroupNameEN
	 , PlazaGroup.PlazaGroupNameTH
	 , UserCreditBalance.UserId
	 , UserCreditBalance.FullNameEN
	 , UserCreditBalance.FullNameTH
	 , TS.ChiefId
	 , TS.ChiefNameEN
	 , TS.ChiefNameTH
  FROM TSB
	 , PlazaGroup
	 , UserCreditBalance LEFT JOIN 
	   (
	    SELECT TSBShift.TSBId
		     , TSBShift.ShiftId AS TSBShiftId
		     , IFNULL(TSBShift.Begin, (SELECT MAX(End) FROM TSBShift)) AS TSBShiftBegin
			 , IFNULL(TSBShift.End, strftime('%Y-%m-%dT%H:%M:%f', 'now', 'localtime')) AS TSBShiftEnd
			 , TSBShift.UserId AS ChiefId
			 , TSBShift.FullNameEN AS ChiefNameEN
			 , TSBShift.FullNameTH AS ChiefNameTH
		  FROM TSBShift
	   ) TS ON (
				    UserCreditBalance.UserCreditDate >= TS.TSBShiftBegin
				AND UserCreditBalance.UserCreditDate <  TS.TSBShiftEnd
				AND UserCreditBalance.TSBId = TS.TSBId
			   )
 WHERE UserCreditBalance.TSBId = TSB.TSBId
   AND UserCreditBalance.PlazaGroupId = PlazaGroup.PlazaGroupId